{% extends 'base.html' %}

{% block upper_left %}
    <div class="nav-container">
        <a class="upper-left" href="{{ url_for('overview') }}">[O]verview</a>
        <span class="separator">|</span>
        <a class="upper-left" href="{{ url_for('configure') }}">General Setup</a>
        <span class="separator">|</span>
        <a class="upper-left" href="{{ url_for('configure_location', loc_id=current.id) }}">Location Setup</a>
    </div>
{% endblock %}

{% block content %}
    <script>
        const linkForKey = {
            'o': '{{ url_for('overview') }}',
        };
        document.addEventListener('DOMContentLoaded', function () {
            document.addEventListener('keypress', function (event) {
                const key = event.key.toLowerCase();
                if (linkForKey[key]) {
                    window.location.href = linkForKey[key];
                }
            });
        });
    </script>
    <h1>{{ current.name }}</h1>
    {% if current.description %}
        <p>{{ current.description }}</p>
    {% endif %}

    {% set width, height = current.grid.dimensions %}
    {% set has_grid = False %}
    {% if width > 0 and height > 0 %}
        {% set has_grid = True %}
    {% endif %}
    <table style="background: transparent"><tr><td valign="top">
    <h2>Characters Here</h2>
    <ul>
        {% for char in game_data.characters if char.location.id == current.id %}
            {% set link = url_for('play_char', char_id=char.id) %}
            {% set letter = link_letters.next(link) %}
            <script>
                linkForKey['{{ letter }}'] = "{{ link }}";
            </script>
            <span>[{{ letter }}]</span>
            <a href="{{ link }}">{{ char.name }}</a>
            {% if has_grid %}
                <span class="label-like">pos [{{char.position[0]}},{{char.position[1]}}]</span>
            {% endif %}
            <br>
        {% else %}
            <p>(None)</p>
        {% endfor %}
    </ul>

    <h2>Items Here</h2>
    <ul class="item-list">
        {% for item_at in current.items %}
            {% set item = item_at.item %}
            {% if item.storage_type == 'local' %}
                {% set link = url_for('play_item', item_id=item.id, loc_id=current.id, char_id=char_id) %}
            {% else %}
                {% set link = url_for('play_item', item_id=item.id, loc_id=current.id) %}
            {% endif %}
            {% set letter = link_letters.next(link) %}
            <script>
                linkForKey['{{ letter }}'] = "{{ link|safe }}";
            </script>
            <span>[{{ letter }}]</span>
            <span class="item-name">
                <a href="{{ link }}">{{ item.name }}</a>
            </span>
            <span class="item-quantity" id="item-{{ item.id }}-quantity">
                {% if not (item_at.item.q_limit == 1 and item_at.quantity == 1) %}
                    {{ item_at.quantity | dec2str }}
                {% endif %}
            </span>
            {% if has_grid %}
                <span class="label-like">pos [{{item_at.position[0]}},{{item_at.position[1]}}]</span>
            {% endif %}
            <br>
        {% else %}
            <p>(None)</p>
        {% endfor %}
    </ul>

    <h2>Neighboring Locations</h2>
    <ul>
        {% for dest in current.destinations.values() %}
            {% if dest.loc.masked %}
                (Unvisited)
            {% else %}
                {% set link = url_for('play_location', loc_id=dest.loc.id) %}
                {% set letter = link_letters.next(link) %}
                <script>
                    linkForKey['{{ letter }}'] = "{{ link }}";
                </script>
                <span>[{{ letter }}]</span>
                <a href="{{ link }}">{{ dest.loc.name }}</a>
            {% endif %}
            â€” Distance {{ dest.distance | dec2str }}<br>
        {% else %}
            <p>(None)</p>
        {% endfor %}
    </ul>
    </td>
    {% set left, top, right, bottom = current.grid.excluded %}
    {% if has_grid %}
    <td valign="top">
        <style>
            td.grid {
                width: 2em;
                height: 2em;
                text-align: center;
                vertical-align: middle;
                padding: 0;
            }
            td.excluded {
                border: none;
            }
            td.included {
                border: 1px solid gray;
                background-color: #2a2a2a;
            }
        </style>
        <table style="background: transparent; border-collapse: collapse; font-family: monospace;">
        {% for y in range(height) %}
            <tr>
                {% for x in range(width) %}
                    {% if left <= x <= right and top <= y <= bottom %}
                        <td class="grid excluded">
                        </td>
                    {% else %}
                        <td class="grid included">
                        {% set cell_info = namespace(filled=False) %}
                        {% for char in game_data.characters if char.location.id == current.id %}
                            {% if char.position[0] == x and char.position[1] == y %}
                                {% if not cell_info.filled %}
                                    {{ char.name[0] }}
                                    {% set cell_info.filled = True %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        {% for item_at in current.items %}
                            {% if item_at.position[0] == x and item_at.position[1] == y %}
                                {% if not cell_info.filled %}
                                    {{ item_at.item.name[0] }}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        </td>
                    {% endif %}
                {% endfor %}
            </tr>
        {% endfor %}
        </table>
    </td>
    {% endif %}
    </tr></table>

    <script>
        $(document).ready(function() {
            function updateQuantities() {
                {% for item_at in current.items %}
                    // Make AJAX request for item quantity
                    $.get('/item/progress_data/{{ item_at.item.id }}', function(data) {
                        $('#item-{{ item_at.item.id }}-quantity').text(data.quantity);
                    });
                {% endfor %}
            }

            // Update quantities initially
            //updateQuantities();

            // Update quantities periodically
            //setInterval(updateQuantities, 10000);
        });
    </script>
{% endblock %}
