{% extends 'base.html' %}

{% block upper_left %}
    <div class="nav-container">
        <a class="upper-left" href="{{ url_for('overview') }}">[O]verview</a>
        <span class="separator">|</span>
        <a class="upper-left" href="{{ url_for('configure_index') }}">[M]ain Setup</a>
        <span class="separator">|</span>
        <a class="upper-left" href="{{ url_for('configure_item', item_id=current.id) }}">Item S[e]tup</a>
    </div>
{% endblock %}

{% block content %}
    <div id="content" style="display:none;">
    <script>
        const linkForKey = {
            'o': '{{ url_for('overview') }}',
            'm': '{{ url_for('configure_index') }}',
            'e': '{{ url_for('configure_item', item_id=current.id) }}',
        };
        document.addEventListener('DOMContentLoaded', function () {
            document.addEventListener('keypress', function (event) {
                const key = event.key.toLowerCase();
                if (key === 'd') {
                    document.getElementById('drop-btn').click();
                } else if (key === 'p') {
                    document.getElementById('pickup-btn').click();
                } else if (key === 'q') {
                    {% if container.pile.slot %}
                        document.getElementById('unequip-btn').click();
                    {% elif game_data.overall.slots %}
                        document.getElementById('equip-btn').click();
                    {% endif %}
                } else if (linkForKey[key]) {
                    window.location.href = linkForKey[key];
                }
            });
        });
    </script>
    <table style="width: 100%; max-width: 80%; margin: 0 auto;">
        <tr>
            <td>
                {% if container.pile.PILE_TYPE == 'universal' %}
                    General Storage<br>
                {% elif container.pile.PILE_TYPE == 'carried' %}
                    {% set link = url_for('play_char', char_id=container.id) %}
                    {% set letter = link_letters.next(link) %}
                    <script>
                        linkForKey['{{ letter }}'] = "{{ link }}";
                    </script>
                    Carried by
                    <a href="{{ link }}">{{ container.name }}</a>
                    <span>[{{ letter }}]</span><br>
                {% elif container.pile.PILE_TYPE == 'local' %}
                    {% set link = url_for('play_location', loc_id=container.id) %}
                    {% set letter = link_letters.next(link) %}
                    <script>
                        linkForKey['{{ letter }}'] = "{{ link }}";
                    </script>
                    At
                    <a href="{{ link }}">{{ container.name }}</a>
                    <span>[{{ letter }}]</span><br>
                {% else %}
                    General Storage (by default)<br>
                {% endif %}
                <h2 style="margin: 10px 10px; display: flex; align-items: center; flex-wrap: nowrap;">
                {{ current.name }}:
                {% if current.q_limit %}
                    <div id="storage-progress-container" class="progress-container" style="display: inline-flex; align-items: center; margin-left: 10px;">
                        <progress id="storage-progress-bar" class="progress-bar" value="0" max="100"></progress>
                        <span class="progress-label" id="storage-progress-label" style="margin-left: 5px; color: white; font-weight: bold;">...</span>
                    </div>
                {% else %}
                    <span id="quantity-{{ current.id }}">...</span>
                {% endif %}
                </h2>
            </td>
        </tr>
        <tr>
            <td>
                <span id="recipe-progress-label" style="">Recipe Progress:</span>
                <div id="action-progress-container" class="progress-container hidden" style="display: inline-flex">
                    <progress id="action-progress-bar" class="progress-bar" value="0" max="100"></progress>
                    <span class="progress-label" id="action-progress-label">0%</span>
                </div>
                <span id="elapsed-time" class="hidden">...</span>
            </td>
        </tr>
        <tr>
            <style>
                .button-container {
                    display: flex;
                    flex-direction: row;
                    align-items: flex-start;
                    gap: 10px;
                }

                .button-column {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-start;
                }
            </style>
            <td>
                <div class="button-container">
                {% if container.pile.PILE_TYPE == 'carried' %}
                    {% if container.pile.slot %}
                        <div class="button-column" id="unequip-container">
                            <button id="unequip-btn" class="go-button">Une[q]uip</button>
                            {{ container.pile.slot }}
                        </div>
                    {% else %}
                        {% if game_data.overall.slots %}
                            <div class="button-column" id="equip-container">
                                <button id="equip-btn" class="go-button">E[q]uip</button>
                                <select id="char-equip-slot">
                                    {% for slot in game_data.overall.slots %}
                                        <option value="{{ slot }}" {% if slot == defaults.slot %}selected{% endif %}>{{ slot }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        {% endif %}
                    {% endif %}
                    <div class="button-column" id="drop-container">
                        <button id="drop-btn" class="go-button">[D]rop</button>
                        <input type="text" id="quantity_to_drop" size="10" value="1">
                    </div>
                {% endif %}
                {% set has = namespace(chars=False) %}
                {% for char in game_data.characters if char.location.id == loc_id %}
                    {% set has.chars = True %}
                {% endfor %}
                {% if container.pile.PILE_TYPE == 'local' and loc_id and has.chars %}
                    <div class="button-column" id="pickup-container">
                        <button id="pickup-btn" class="go-button">[P]ick Up</button>
                        <select id="char-picking-up">
                            {% for char in game_data.characters if char.location.id == loc_id %}
                                <option value="{{ char.id }}" {% if char.id == defaults.pickup_char %}selected{% endif %}>{{ char.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                {% endif %}
                {% if container.pile.PILE_TYPE == 'universal' %}
                    <div class="button-column" id="move_to_char-container">
                        <button id="move_to_char-btn" class="go-button">Move to [C]haracter</button>
                        <select id="char-moving-to">
                            {% for char in game_data.characters %}
                                <option value="{{ char.id }}" {% if char.id == defaults.movingto_char %}selected{% endif %}>{{ char.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="button-column" id="move_to_loc-container">
                        <button id="move_to_loc-btn" class="go-button">Move to [L]ocation</button>
                        <select id="loc-moving-to">
                            {% for loc in game_data.locations %}
                                <option value="{{ loc.id }}" {% if loc.id == defaults.movingto_loc %}selected{% endif %}>{{ loc.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                {% else %}
                    <div class="button-column" id="move_to_general-container">
                        <button id="move_to_general-btn" class="go-button">Move to [G]eneral Storage</button>
                        <input type="text" id="quantity_to_move" size="10" value="1">
                    </div>
                {% endif %}
                <div id="show_all_buttons-container">
                    <input type="checkbox" id="show-all-buttons" /><label for="show-all-buttons">Show all actions</label>
                </div>
                <div><br><br><br></div><!-- so that buttons appearing doesn't cause movement -->
                </div>
            </td>
        </tr>
<!--
        <tr>
            <td style="background-color: #2a2a2a; border-bottom: 2px solid #ffffff;">
            </td>
        </tr>
-->
        {% if current.description %}
        <tr>
            <td>
                <p>{{ current.description|htmlify }}</p>
            </td>
        </tr>
        {% endif %}
        {% if current.attribs %}
        <tr>
            <td>
                <h2>Attributes</h2>
                <ul>
                    {% for attrib_of in current.attribs.values() %}
                        <li>{{ attrib_of.attrib.name }}
                            {% if attrib_of.val != 1 %}
                                {{ attrib_of.val | formatNum }}
                            {% endif %}
                        </li>
                    {% else %}
                        (None)<br>
                    {% endfor %}
                </ul>
            </td>
        </tr>
        {% endif %}
        {% if current.recipes %}
        <tr>
            <td>
                <style>
                    .nested-table {
                        width: 100%;
                        border-collapse: collapse;
                    }

                    .nested-table td {
                        height: 25px;
                        vertical-align: middle;
                        /* border: 1px solid #888; */
                    }
                </style>
                <table class="inner-table spacious" cellspacing="0" cellpadding="5">
                    <tr>
                        <th>Batches</th>
                        <th>Rate</th>
                        <th>Source</th>
                        <th>Required</th>
                        <th>In Stock</th>
                        <th>Where</th>
                    </tr>
            {% for recipe in current.recipes %}
                {% if recipe.id != current.recipes[0].id %}
                <tr style="border-top: 1px solid #888;"></tr>
                {% endif %}
                <tr><td colspan="2" style="vertical-align: top;"><table class="nested-table">
                    <tr>
                        <td>
                            {% if recipe.instant %}
                            <input type="text" class="quantity_to_gain" id="quantity_to_gain_{{ recipe.id }}" size="10" value="{{ session['quantity_to_gain'] if session['quantity_to_gain'] else 1 }}">
                            <button type="button" data-recipe-id="{{ recipe.id }}" data-rate-amount="{{ recipe.rate_amount }}" class="gain-btn go-button" id="gain-btn_{{ recipe.id }}">Gain</button>
                            {% else %}
                            <button type="button" class="start-stop-btn go-button" id="start-stop-btn_{{ recipe.id }}" data-recipe-id="{{ recipe.id }}">Start</button>
                            {% endif %}
                        </td>
                        <td>
                            <span class="rate-amount" id="rate-amount_{{ recipe.id }}">
                                {% if recipe.rate_amount %}{{ recipe.rate_amount | formatNum }}
                                {% else %}<span style="font-size: 2em" title="(trash can icon) does not produce the current item">&#x1F5D1;</span>{% endif %}
                            </span>
                            {% if not recipe.instant %}
                            {% if recipe.rate_amount %}per {% endif %}<span class="rate-duration" id="rate-duration_{{ recipe.id }}">{{ recipe.rate_duration | formatNum }}</span>s
                            {% endif %}
                        </td>
                    </tr>
                {% for byproduct in recipe.byproducts %}
                    {% set item = byproduct.item %}
                    <tr>
                        {% set link = url_for('play_item', item_id=item.id, char_id=char_id, loc_id=loc_id) %}
                        {% set letter = link_letters.next(link) %}
                        <script>
                            linkForKey['{{ letter }}'] = "{{ link|safe }}";
                        </script>
                        <td>
                            <strong title="byproduct">&amp;</strong>
                            <span>[{{ letter }}]</span>
                            <a href="{{ link }}">{{ item.name }}</a>
                        </td>
                        <td>
                            {{ byproduct.rate_amount | formatNum }}
                        </td>
                    </tr>
                {% endfor %}
                </table></td><td colspan="4" style="vertical-align: top;"><table class="nested-table">
                {% for source in recipe.sources %}
                    {% set item = source.item %}
                    <tr>
                        {% if item.id == current.id %}
                            <td><strong>{{ item.name}}</strong></td>
                        {% else %}
                            {% set link = url_for('play_item', item_id=item.id, char_id=char_id, loc_id=loc_id) %}
                            {% set letter = link_letters.next(link) %}
                            <script>
                                linkForKey['{{ letter }}'] = "{{ link|safe }}";
                            </script>
                            <td>
                                <span>[{{ letter }}]</span>
                                <a href="{{ link }}">{{ item.name }}</a>
                            </td>
                        {% endif %}
                        <td>
                            {% if source.preserve %}
                                ({{ source.q_required | formatNum }})
                            {% else %}
                                {{ source.q_required | formatNum }}
                            {% endif %}
                        </td>
                        <td id="recipe-{{ recipe.id }}-source-{{ item.id }}-quantity">
                        {% if source.pile %}
                            {{ source.pile.quantity | formatNum }}
                        {% else %}
                            <div style="text-align: center">&mdash;</div>
                        {% endif %}
                        </td>
                        <td id="recipe-{{ recipe.id }}-source-{{ item.id }}-at">
                        {% if source.pile and source.pile.quantity > 0 %}
                            {% set container = source.pile.container %}
                            {% if source.pile.PILE_TYPE == 'universal' %}
                                (General)
                            {% else %}
                                {% if source.pile.PILE_TYPE == 'carried' %}
                                    {% set link = url_for('play_char', char_id=container.id) %}
                                {% elif source.pile.PILE_TYPE == 'local' %}
                                    {% set link = url_for('play_location', loc_id=container.id) %}
                                {% else %}
                                    {% set link = '/unexpected-pile-type' %}
                                {% endif %}
                                {% set letter = link_letters.next(link) %}
                                <script>
                                    linkForKey['{{ letter }}'] = "{{ link }}";
                                </script>
                                <span>[{{ letter }}]</span>
                                <a href="{{ link }}">{{ container.name }}</a><br>
                            {% endif %}
                        {% else %}
                            <div style="text-align: center">&mdash;</div>
                        {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                {% for req in recipe.attribs.values() %}
                    <tr>
                        <td>{{ req.attrib.name }}</td>
                        <td>
                            ({{ req.val | formatNum }})
                        </td>
                        {% if req.entity %}
                            {% set entity = req.entity %}
                            <td>{{ entity.attribs[req.attrib.id].val | formatNum }}</td>
                            {% if entity.__class__.__name__ == 'Character' %}
                                {% set link = url_for('play_char', char_id=entity.id) %}
                            {% elif entity.__class__.__name__ == 'Item' %}
                                {% set link = url_for('play_item', item_id=entity.id) %}
                            {% else %}
                                {% set link = '/unexpected-entity-type' %}
                            {% endif %}
                            {% set letter = link_letters.next(link) %}
                            <script>
                                linkForKey['{{ letter }}'] = "{{ link }}";
                            </script>
                            <td>
                                <span>[{{ letter }}]</span>
                                <a href="{{ link }}">{{ entity.name }}</a>
                            </td>
                        {% else %}
                            <td>(0)</td>
                            <td>(None)</td>
                        {% endif %}
                    </tr>
                {% endfor %}
                </table></td></tr></table>
            {% endfor %}
                </table>
            </td>
        </tr>
        {% endif %}

        {% set outerscope = namespace(used_as_source=[], produced_as_byproduct=[]) %}
        {% for other_item in game_data.items %}
            {% if other_item.id != current.id %}  {# e.g. pigs breeding pigs #}
                {% for recipe in other_item.recipes %}
                    {% for source in recipe.sources %}
                        {% if current.id == source.item.id %}
                            {% set _ = outerscope.used_as_source.append(
                                {'item': other_item, 'q_required': source.q_required}) %}
                        {% endif %}
                    {% endfor %}
                    {% for byproduct in recipe.byproducts %}
                        {% if current.id == byproduct.item.id %}
                            {% set _ = outerscope.produced_as_byproduct.append(
                                {'item': other_item, 'rate_amount': byproduct.rate_amount}) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endif %}
        {% endfor %}
        {% if outerscope.used_as_source %}
        <tr>
            <td>
                <table class="inner-table spacious" cellspacing="0" cellpadding="5">
                    <tr>
                        <th>Used For</th>
                        <th>Required</th>
                    </tr>
                    {% for used_for in outerscope.used_as_source %}
                        {% set link = url_for('play_item', item_id=used_for.item.id, char_id=char_id, loc_id=loc_id) %}
                        {% set letter = link_letters.next(link) %}
                        <script>
                            linkForKey['{{ letter }}'] = "{{ link|safe }}";
                        </script>
                    <tr>
                        <td>
                            <span>[{{ letter }}]</span>
                            <a href="{{ link }}">{{ used_for.item.name }}</a>
                        </td>
                        <td>{{ used_for.q_required | formatNum }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </td>
        </tr>
        {% endif %}
        {% if outerscope.produced_as_byproduct %}
        <tr>
            <td>
                <table class="inner-table spacious" cellspacing="0" cellpadding="5">
                    <tr>
                        <th>Byproduct of a Recipe for</th>
                    </tr>
                    {% for byproduct_of in outerscope.produced_as_byproduct %}
                        {% set link = url_for('play_item', item_id=byproduct_of.item.id, char_id=char_id, loc_id=loc_id) %}
                        {% set letter = link_letters.next(link) %}
                        <script>
                            linkForKey['{{ letter }}'] = "{{ link|safe }}";
                        </script>
                    <tr>
                        <td>
                            <span>[{{ letter }}]</span>
                            <a href="{{ link }}">{{ byproduct_of.item.name }}</a>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </td>
        </tr>
        {% endif %}
    </table>

    <script>
        $(document).ready(function() {
            let mainQuantity = 0;

            function updateQuantity(data) {
                // Main item quantity
                $('#quantity-{{ current.id }}').text(
                    data.quantity_str
                    {% if current.q_limit != 0 %} + " / " + {{ current.q_limit }}{% endif %}
                );
                updateStorageProgress({
                    quantity: data.quantity,
                    max_quantity: {{ current.q_limit or 0 }}
                });
                mainQuantity = data.quantity;
                // Source item quantities required
                let url;
                {% for recipe in current.recipes %}
                    {% for source in recipe.sources %}
                        url = getItemProgressUrl({{ source.item.id }})
                        $.get(url, function(data) {
                            $('#recipe-{{ recipe.id }}-source-{{ source.item.id }}-quantity').text(data.quantity_str);
                        });
                    {% endfor %}
                {% endfor %}
            }
            function updateStorageProgress(data) {
                const progressBar = $('#storage-progress-bar');
                const progressLabel = $('#storage-progress-label');

                const quantity = data.quantity || 0;
                const maxQuantity = data.max_quantity || 0;
                if (maxQuantity === 0) {
                    // Don't show bar
                    return;
                }
                const progressPercent = (quantity / maxQuantity) * 100;
                progressBar.attr('value', progressPercent);
                progressBar.attr('max', 100);
                progressLabel.text(`${quantity} / ${maxQuantity}`);
            }
            function getItemProgressUrl(itemId, mainPileType='') {
                const queryParams = [];
                const charId = "{{ char_id }}";
                if (charId) {
                    queryParams.push('char_id=' + encodeURIComponent(charId));
                }
                const locId = "{{ loc_id }}";
                if (locId) {
                    queryParams.push('loc_id=' + encodeURIComponent(locId));
                }
                if (mainPileType) {
                    queryParams.push('main=' + encodeURIComponent(mainPileType));
                }
                let url = '/item/progress/' + itemId;
                if (queryParams.length > 0) {
                    url += '?' + queryParams.join('&');
                }
                return url;
            }

            // Global variable to store the elapsed time.
            let elapsedTime = 0;
            let rateDuration = 1;
            let in_progress = false;

            function updateActionProgress() {
                console.log('Updating progress bar:', { elapsedTime, rateDuration });
                const progressBar = $('#action-progress-bar');
                const progressLabel = $('#action-progress-label');
                const effectiveElapsedTime = elapsedTime % rateDuration;
                const progressPercent = (effectiveElapsedTime / rateDuration) * 100;
                progressBar.val(progressPercent);
                progressLabel.text(`${Math.floor(effectiveElapsedTime)} / ${rateDuration} sec`);
            }

            // Update the elapsed time on the client.
            function updateElapsedTime() {
                // Increment the elapsed time by 1 second
                if (in_progress) {
                    elapsedTime += 1;
                }
                $('#elapsed-time').text(formatTime(elapsedTime));
            }

            // Function to format the time in HH:MM:SS format.
            function formatTime(time) {
              const hours = Math.floor(time / 3600);
              const minutes = Math.floor((time % 3600) / 60);
              const seconds = Math.floor(time % 60);
              return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // Reconcile the elapsed time with the server-side progress time.
            function reconcileElapsedTime(data) {
                if (data.elapsed_time) {
                    elapsedTime = data.elapsed_time;
                } else {
                    elapsedTime = 0;
                }
                //$('#dest-time').text(formatTime(elapsedTime));
            }

            // the Start button can change to "Stop"
            function updateStartButtonLabel(data, recipe_id) {
                const startBtns = document.querySelectorAll(".start-stop-btn");
                for (const startBtn of startBtns) {
                    const btnRecipeId = startBtn.getAttribute("data-recipe-id");
                    if (btnRecipeId && parseInt(btnRecipeId) === recipe_id) {
                        if (data && data.is_ongoing) {
                            startBtn.innerHTML = "Stop";
                            startBtn.classList.add("dangerous-button");
                            startBtn.classList.remove("go-button");
                        } else {
                            startBtn.innerHTML = "Start";
                            startBtn.classList.add("go-button");
                            startBtn.classList.remove("dangerous-button");
                        }
                    }
                }
            }

            function updateProgressVisibility() {
                if (!in_progress) {
                    $('#action-progress-container').addClass('hidden');
                    $('#recipe-progress-label').addClass('hidden');
                    return;
                }
                if (rateDuration < 5) {
                    $('#action-progress-container').addClass('hidden');
                    $('#recipe-progress-label').addClass('hidden');
                } else {
                    $('#action-progress-container').removeClass('hidden');
                    $('#recipe-progress-label').removeClass('hidden');
                }
            }

            // Fetch progress data and update all relevant information
            async function fetchProgressData() {
                const url = getItemProgressUrl({{ current.id }}, "{{ main_pile_type }}")
                const data = await new Promise((resolve, reject) => {
                    $.get(url, function(response) {
                        resolve(response);
                    }).fail(function(xhr, status, error) {
                        reject(error);
                    });
                });
                updateQuantity(data);
                updateActionProgress();
                in_progress = data.is_ongoing;
                reconcileElapsedTime(data);
                updateStartButtonLabel(data, data.recipe_id);
                updateProgressVisibility();
                updateVisibility();
            }
            function showContent() {
                document.getElementById("content").style.display = "block";
            }
            async function initializePage() {
                await fetchProgressData();
                startFetchingProgress();
                updateElapsedTime();
                setInterval(updateElapsedTime, 1000);
                await updateVisibility();
                showContent();
            }
            initializePage();

            var fetchProgressInterval;
            function startFetchingProgress() {
                if (fetchProgressInterval) {
                    stopFetchingProgress();
                }
                fetchProgressInterval = setInterval(fetchProgressData, 2000);
            }
            function stopFetchingProgress() {
                clearInterval(fetchProgressInterval);
                fetchProgressInterval = null;
            }

            $('.gain-btn').click(function() {
                const quantityInput = $(this).prev('.quantity_to_gain');
                const quantity = parseInt(quantityInput.val(), 10);
                const recipe_id = $(this).data('recipe-id');
                const rate_amount = $(this).data('rate-amount');
                const minResultQty = parseInt(rate_amount, 10);
                if (isNaN(quantity) || quantity < 1) {
                    alert('Please enter a valid number for the quantity.');
                    return;
                }
                const item_id = {{ current.id }}
                stopFetchingProgress();
                $.ajax({
                    url: '/item/gain/' + item_id + '/' + recipe_id,
                    method: 'POST',
                    data: { quantity: quantity },
                    success: function(response) {
                        if (response.status === 'error') {
                            console.error(response.message);
                            alert(response.message);
                        }
                    },
                    error: function(error) {
                        console.error('Error:', error);
                        alert('Error: ' + error);
                    },
                    complete: function() {
                        fetchProgressData();
                        startFetchingProgress();
                    }
                });
            });
            $('.start-stop-btn').click(function() {
                const current_id = {{ current.id }};
                const startBtn = this;
                const recipe_id = $(this).data('recipe-id');
                const row = $(this).closest('tr');
                rateDuration = parseFloat(row.find('.rate-duration').text()) || 1;
                console.log(`start/stop button clicked for recipe ${recipe_id}`);
                const urlParts = ['/item/stop', current_id];
                if (startBtn.innerHTML === "Start") {
                    urlParts[0] = '/item/start';
                    urlParts.push(recipe_id);
                }
                const url = urlParts.join('/');
                console.log(`url ${url}`);
                stopFetchingProgress();
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        if (data.status === 'error') {
                            console.error('Could not start or stop:', data.message);
                            alert(data.message);
                        }
                        updateStartButtonLabel(data, recipe_id);
                        fetchProgressData();
                        startFetchingProgress();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        startFetchingProgress();
                    });
            });
            $('#drop-btn').click(function() {
                const itemId = "{{ current.id }}";
                const charId = "{{ container.id }}";
                $.ajax({
                    url: `/item/drop/${itemId}/char/${charId}`,
                    method: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            const url = "{{ url_for('play_char', char_id=container.id) }}";
                            window.location.href = url;
                        } else {
                            console.error(response.message);
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(error) {
                        console.error('Error:', error);
                        alert('Error: ' + error);
                    }
                });
            });
            $('#pickup-btn').click(function() {
                const itemId = "{{ current.id }}";
                const locId = "{{ container.id }}";
                const charId = $('#char-picking-up').val();
                if (!charId) {
                    alert('Please select a character to pick up the item.');
                    return;
                }
                $.ajax({
                    url: `/item/pickup/${itemId}/loc/${locId}/char/${charId}`,
                    method: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            const url = "{{ url_for('play_location', loc_id=container.id) }}";
                            window.location.href = url;
                        } else {
                            console.error(response.message);
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(error) {
                        console.error('Error:', error);
                        alert('Error: ' + error);
                    }
                });
            });
            $('#equip-btn').click(function() {
                const itemId = "{{ current.id }}";
                const charId = "{{ container.id }}";
                const slot = $('#char-equip-slot').val();
                if (!slot) {
                    alert('Please select a slot to equip the item.');
                    return;
                }
                $.ajax({
                    url: `/item/equip/${itemId}/char/${charId}/slot/${slot}`,
                    method: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            const url = "{{ url_for('play_char', char_id=container.id) }}";
                            window.location.href = url;
                        } else {
                            console.error(response.message);
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(error) {
                        console.error('Error:', error);
                        alert('Error: ' + error);
                    }
                });
            });
            $('#unequip-btn').click(function() {
                const itemId = "{{ current.id }}";
                const charId = "{{ container.id }}";
                $.ajax({
                    url: `/item/unequip/${itemId}/char/${charId}`,
                    method: 'POST',
                    success: function(response) {
                        if (response.status === 'success') {
                            window.location.href = "{{ url_for('play_char', char_id=container.id) }}";
                        } else {
                            console.error(response.message);
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(error) {
                        console.error('Error:', error);
                        alert('Error: ' + error);
                    }
                });
            });

            async function updateVisibility() {
                const storageType = '{{ current.storage_type }}';
                const showAll = $('#show-all-buttons').is(':checked');
                const storage_carried = storageType === 'carried';
                const notEmpty = mainQuantity !== 0;
                const slot = {% if container.pile.slot %}true{% else %}false{% endif %};
                const visibilityMap = {
                    'unequip-container': (notEmpty && slot && (showAll || storage_carried)),
                    'equip-container': (notEmpty && (showAll || storage_carried)),
                    'drop-container': (notEmpty && !slot && (showAll || storage_carried)),
                    'pickup-container': (notEmpty && (showAll || storage_carried)),
                    'move_to_char-container': (notEmpty && (showAll || storage_carried)),
                    'move_to_loc-container': (notEmpty && (showAll || storageType === 'local')),
                    'move_to_general-container': (notEmpty && (showAll || storageType === 'general')),
                    'show_all_buttons-container': (mainQuantity != 0),
                };
                Object.keys(visibilityMap).forEach(function(id) {
                    if (visibilityMap[id]) {
                        $('#' + id).show();
                    } else {
                        $('#' + id).hide();
                    }
                });
                const showThese = [];
                const hideThese = [];
                $('.show-if-carried').each(function() {
                    if (showAll || storageType === 'carried') {
                        showThese.push(this);
                    } else {
                        hideThese.push(this);
                    }
                });
                $('.show-if-local').each(function() {
                    if (showAll || storageType === 'local') {
                        showThese.push(this);
                    } else {
                        hideThese.push(this);
                    }
                });
                $('.show-if-universal').each(function() {
                    if (showAll || storageType === 'universal') {
                        showThese.push(this);
                    } else {
                        hideThese.push(this);
                    }
                });
                $('.hide-if-empty').each(function() {
                    if (mainQuantity != 0) {
                        /*
                        if (!showThese.includes(this)) {
                            showThese.push(this);
                        }
                        const index = showThese.indexOf(this);
                        if (index > -1) {
                            hideThese.splice(index, 1);
                        }
                        */
                    } else {
                        const index = showThese.indexOf(this);
                        if (index > -1) {
                            showThese.splice(index, 1);
                        }
                        if (!hideThese.includes(this)) {
                            hideThese.push(this);
                        }
                    }
                });
                $('.hide-if-slot').each(function() {
                    {% if container.pile.slot %}
                        if (showAll) {
                            if (!showThese.includes(this)) {
                                showThese.push(this);
                            }
                            const index = showThese.indexOf(this);
                            if (index > -1) {
                                hideThese.splice(index, 1);
                            }
                        } else {
                            const index = showThese.indexOf(this);
                            if (index > -1) {
                                showThese.splice(index, 1);
                            }
                            if (!hideThese.includes(this)) {
                                hideThese.push(this);
                            }
                        }
                    {% endif %}
                });
                showThese.forEach(el => $(el).show());
                hideThese.forEach(el => $(el).hide());
            }
            $('#show-all-buttons').on('change', function() {
                updateVisibility();
            });
        });
    </script>
    </div><!-- content -->
{% endblock %}
