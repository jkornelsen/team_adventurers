<!DOCTYPE html>
<html>
<head>
    <title>Item Information</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="nav-container">
        <a class="upper-left" href="{{ url_for('overview') }}">Overview</a>
        <span class="separator">|</span>
        <a class="upper-left" href="{{ url_for('configure') }}">General Setup</a>
        <span class="separator">|</span>
        <a class="upper-left" href="{{ url_for('configure_item', item_id=current.id) }}">Item Setup</a>
    </div>
    <table>
        <tr>
            <td style="background-color: #2a2a2a; border-bottom: 2px solid #ffffff;">
                <h2 style="margin: 10px 10px">{{ current.name }}:
                <span id="quantity-{{ current.id }}">...</span>
                </h2>
            </td>
        </tr>
        {% if current.description %}
        <tr>
            <td>
                <p>{{ current.description }}</p>
            </td>
        </tr>
        {% endif %}
        {% if current.growable == 'over_time' %}
        <tr>
            <td>
                Rate: <span id="rate-amount">{{ current.timer.rate_amount }}</span> per 
                <span id="rate-duration">{{ current.timer.rate_duration }}</span> seconds
            </td>
        </tr>
        <tr>
            <td>
                Elapsed Time: <span id="elapsed-time">...</span>
            </td>
        </tr>
        {% endif %}
        {% if current.growable != 'not_growable' %}
        <tr>
            <td>
                Gives: {{ current.result_qty }}
            </td>
        </tr>
        {% endif %}
        {% if current.sources %}
        <tr>
            <td>
                <table class="inner-table" cellspacing="0" cellpadding="5">
                    <tr>
                        <th>Source Item</th>
                        <th>In Stock</th>
                        <th>Required</th>
                    </tr>
                    {% for source_item, quantity in current.sources.items() %}
                    <tr>
                        <td>
                            <a href="{{ url_for('play_item', item_id=source_item.id) }}">
                                {{ source_item.name }}
                            </a>
                        </td>
                        <td id="source-{{ source_item.id }}-quantity">...</td>
                        <td>{{ quantity }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </td>
        </tr>
        {% endif %}

        {% set outerscope = namespace(used_for_items=[]) %}
        {% for other_item in current.game_data.items %}
            {% if current in other_item.sources %}
                {% set _ = outerscope.used_for_items.append(other_item) %}
            {% endif %}
        {% endfor %}
        {% if outerscope.used_for_items %}
        <tr>
            <td>
                <table class="inner-table" cellspacing="0" cellpadding="5">
                    <tr>
                        <th>Used For</th>
                        <th>Required</th>
                    </tr>
                    {% for used_for_item in outerscope.used_for_items %}
                    {% set quantity = used_for_item.sources[current] %}
                    <tr>
                        <td>
                            <a href="{{ url_for('play_item', item_id=used_for_item.id) }}">
                                {{ used_for_item.name }}
                            </a>
                        </td>
                        <td>{{ quantity }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </td>
        </tr>
        {% endif %}
    </table>

    {% if current.growable == 'over_time' %}
    <button id="start-btn" {% if current.timer.is_running %}disabled{% endif %}>
        {% if current.timer.is_running %}Running...{% else %}Start{% endif %}
    </button>
    <button id="stop-btn"{% if not current.timer.is_running %}disabled{% endif %}>Stop</button>
    {% elif current.growable == 'instantly' %}
    <input type="number" id="quantity_to_gain" size="10" value="{{ current.result_qty }}">
    <button id="gain-btn">Gain</button>
    {% endif %}

    <script>
        $(document).ready(function() {
            function updateQuantity() {
                // Main item quantity
                $.get('/item/quantity/{{ current.id }}', function(data) {
                    $('#quantity-{{ current.id }}').text(data.quantity);
                });

                // Source item quantities
                {% for source_item, _ in current.sources.items() %}
                $.get('/item/quantity/{{ source_item.id }}', function(data) {
                    $('#source-{{ source_item.id }}-quantity').text(data.quantity);
                });
                {% endfor %}
            }

            // Update Elapsed time
            function updateElapsedTime() {
                $.get('/item/time/{{ current.id }}', function(data) {
                    $('#elapsed-time').text(data.time);
                });
            }

            // the Start button may change to "Running..."
            function updateStartbuttonLabel() {
                fetch('/item/timer_status/{{ current.id }}')
                    .then(response => response.json())
                    .then(data => {
                        var startBtn = document.getElementById("start-btn");
                        var stopBtn = document.getElementById("stop-btn");
                        if (data.is_running) {
                            startBtn.innerHTML = "Running...";
                            startBtn.disabled = true;
                            stopBtn.disabled = false;
                        } else {
                            startBtn.innerHTML = "Start";
                            startBtn.disabled = false;
                            stopBtn.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }

            // Update quantities and elapsed time initially
            updateQuantity();
            updateElapsedTime();

            // Update quantities, elapsed time, and rate every second
            setInterval(function() {
                updateQuantity();
                {% if current.growable == 'over_time' %}
                    updateElapsedTime();
                    updateStartbuttonLabel();
                {% endif %}
            //}, 1000);
            }, 5000);

            // Button click event handlers
            $('#gain-btn').click(function() {
                var quantity = parseInt($('#quantity_to_gain').val(), 10);
                var minResultQty = parseInt('{{ current.result_qty }}', 10);
                if (quantity < minResultQty) {
                    alert('Minimum quantity to gain is ' + minResultQty + '.');
                    return; // Stop further processing
                }
                item_id = {{ current.id }}
                quantity = $('#quantity_to_gain').val();
                $.ajax({
                    url: '/item/gain/' + item_id,
                    method: 'POST',
                    data: { quantity: quantity },
                    success: function(response) {
                        if (response.status === 'error') {
                            console.error(response.message);
                            alert(response.message);
                        }
                    },
                    error: function(error) {
                        console.error('Error:', error);
                    },
                    complete: function() {
                        updateQuantity();
                    }
                });
            });
            $('#start-btn').click(function() {
                var item_id = {{ current.id }};
                console.log('startItem(): ' + item_id);
                fetch('/item/start/' + item_id)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        if (data.status === 'error') {
                            console.error('Could not start:', data.message);
                            alert(data.message);
                        }
                        updateStartbuttonLabel();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
            $('#stop-btn').click(function() {
                item_id = {{ current.id }}
                console.log('stopItem(): ' + item_id);
                fetch('/item/stop/' + item_id)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        updateStartbuttonLabel();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
        });
    </script>
</body>
</html>
