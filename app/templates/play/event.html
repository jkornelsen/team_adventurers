{% extends 'base.html' %}

{% block upper_left %}
    <div class="nav-container">
        <a class="upper-left" href="{{ url_for('overview') }}">[O]verview</a>
        <span class="separator">|</span>
        <a class="upper-left" href="{{ url_for('configure_index') }}">[M]ain Setup</a>
        <span class="separator">|</span>
        <a class="upper-left" href="{{ url_for('configure_event', event_id=current.id) }}">Event S[e]tup</a>
    </div>
{% endblock %}

{% block content %}
    <script>
        const linkForKey = {
            'o': '{{ url_for('overview') }}',
            'm': '{{ url_for('configure_index') }}',
            'e': '{{ url_for('configure_event', event_id=current.id) }}',
        };
        document.addEventListener('DOMContentLoaded', function () {
            document.addEventListener('keypress', function (event) {
                const key = event.key.toLowerCase();
                if (key === 'r') {
                    document.getElementById('roll-btn').click();
                } else if (linkForKey[key]) {
                    window.location.href = linkForKey[key];
                } else if (key === 'f') {
                    const firstBtn = document.querySelector('.fill-btn');
                    if (firstBtn) {
                        firstBtn.click();
                    }
                } else if (key === 'l') {
                    const firstBtn = document.querySelector('.fill-changed-btn');
                    if (firstBtn) {
                        firstBtn.click();
                    }
                } else if (key === 'a') {
                    const firstBtn = document.querySelector('button[name="change_attrib"]');
                    if (firstBtn) {
                        firstBtn.click();
                    }
                }
            });
        });
    </script>
    <h1>{{ current.name }}</h1>
    {% if current.description %}
        <p>{{ current.description|htmlify }}</p>
    {% endif %}
    <table class="spacious">
        <tr>
            <td>
                <form method="POST" action="{{ url_for('play_event', event_id=current.id) }}">
                    {% if current.outcome_type == 'fourway' %}
                        <label for="difficulty" style="padding-left: 10px;">Difficulty:</label>
                        <select id="difficulty" name="difficulty">
                            <option value="5">Easy (5)</option>
                            <option value="10">Moderate (10)</option>
                            <option value="15">Hard (15)</option>
                            <option value="20">Very Hard (20)</option>
                        </select><br>
                    {% endif %}
                    {% if current.outcome_type == 'fourway' or current.outcome_type == 'numeric' %}
                        <div style="background-color: black; margin: 3px; padding: 10px">
                        <label for="stat_adjustment">Stat Adjustment:</label>
                        <input type="text" id="stat_adjustment" name="stat_adjustment" value="{{ current.stat_adjustment }}">
                        <br>
                        {% for attr in current.determining_attrs %}
                            <li style="margin-top: 5px">{{ attr.name }}
                            <select class="char-for-attr" id="char-for-attr_{{ attr.id }}">
                                <option value="" selected>(Select character)</option>
                                {% for char in game_data.characters if attr.id in char.attribs %}
                                    {% set attrib_val = char.attribs[attr.id].val | formatNum %}
                                    <option value="{{ attrib_val }}" {% if char.id == session['last_char_id'] %}selected{% endif %}>{{ char.name }} {{ attrib_val }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="fill-btn" data-attr-id="{{ attr.id }}">
                                {% if loop.first %}[F]ill{% else %}Fill{% endif %}
                            </button><br>
                        {% endfor %}
                        </div>
                    {% endif %}
                    <div style="margin-top: 20px; text-align: center">
                    <button type="submit" id="roll-btn" name="roll">[R]oll</button>
                    </div>
                </form>
            </td>
        </tr>
        <tr>
            <td>
                <div id="outcome-display" style="height: 3em;">{{ outcome_display|safe }}</div>
            </td>
        </tr>
        {% if current.outcome_type == 'numeric' %}
        <tr>
            <td>
            <div style="background-color: black; margin: 3px; padding: 10px">
            <label for="stat_adjustment">Affected Stats:</label>
            {% for attr in current.changed_attrs %}
                <form method="POST" action="{{ url_for('play_event', event_id=current.id) }}">
                <input type="hidden" name="attr_id" value="{{ attr.id }}">
                <input type="hidden" name="char_id" value="0" id="char_id_{{ attr.id }}">
                <li style="margin-top: 5px">{{ attr.name }}
                <select class="char-for-changed" id="char-for-changed_{{ attr.id }}">
                    <option value="" selected>(Select character)</option>
                    {% for char in game_data.characters if attr.id in char.attribs %}
                        {% set attrib_val = char.attribs[attr.id].val | formatNum %}
                        <option value="{{ attrib_val }}" data-char-id="{{ char.id }}" {% if char.id == session['last_affected_char_id'] %}selected{% endif %}>{{ char.name }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="fill-changed-btn" data-attr-id="{{ attr.id }}">
                    {% if loop.first %}Fil[l]{% else %}Fill{% endif %}
                </button>
                <span id="oldval_{{ attr.id }}" style="min-width: 5ch; display: inline-block; text-align: right;">0</span> &rarr;
                <input type="text" name="newval" id="newval_{{ attr.id }}" size="8">
                <button type="submit" name="change_attrib" id="apply_{{ attr.id }}" data-attr-id="{{ attr.id }}">
                    {% if loop.first %}[A]pply{% else %}Apply{% endif %}
                </button><br>
                </form>
            {% endfor %}
            </div>
            </td>
        </tr>
        {% endif %}
    </table>
    {% if message %}
        <p>{{ message }}</p>
    {% endif %}
    <script>
        $(document).ready(function() {
            // remember default for select box in client side storage
            let selectedDifficulty = localStorage.getItem('selectedDifficulty');
            if (selectedDifficulty === null) {
                selectedDifficulty = '10';
                localStorage.setItem('selectedDifficulty', selectedDifficulty);
            }
            $('#difficulty').val(selectedDifficulty);
            $('#difficulty').on('change', function() {
                localStorage.setItem('selectedDifficulty', this.value);
            });
            
            function updateStatAdjustment(event) {
                const selectedValue = event.target.value;
                const statAdjustmentInput = document.getElementById('stat_adjustment');
                statAdjustmentInput.value = selectedValue;
            }
            $('.char-for-attr').on('change', updateStatAdjustment);

            $('.fill-btn').on('click', function() {
                const attrId = $(this).data('attr-id');
                const selectedValue = $('#char-for-attr_' + attrId).val();
                $('#stat_adjustment').val(selectedValue);
            });
            $('.fill-changed-btn').on('click', function() {
                const attrId = $(this).data('attr-id');
                $('#char-for-changed_' + attrId).change();
            });

            $('.char-for-changed').change(function() {
                const selectedOption = $(this).find(':selected');
                const attribVal = parseFloat(selectedOption.val()) || 0;
                const attribId = this.id.split('_')[1];
                const charId = selectedOption.data('char-id');
                const currentOutcome = {{ current.outcome }};
                const oldValText = $(`#oldval_${attribId}`);
                const newValInput = $(`#newval_${attribId}`);
                const newValue = attribVal + currentOutcome;
                if (oldValText.text() !== attribVal.toString()) {
                    oldValText.text(attribVal);
                    newValInput.val(newValue);
                    $(`#char_id_${attribId}`).val(charId);
                }
            });
        });
    </script>
{% endblock %}
