{% extends 'base.html' %}

{% block upper_left %}
    <div class="nav-container">
        <a class="upper-left" href="{{ url_for('overview') }}">[O]verview</a>
        <span class="separator">|</span>
        <a class="upper-left" href="{{ url_for('configure_event', event_id=current.id) }}">Event S[e]tup</a>
    </div>
{% endblock %}

{% block content %}
    <script>
        const linkForKey = {
            'o': '{{ url_for('overview') }}',
            'e': '{{ url_for('configure_event', event_id=current.id) }}',
        };
        document.addEventListener('DOMContentLoaded', function () {
            document.addEventListener('keypress', function (event) {
                const key = event.key.toLowerCase();
                if (key === 'r') {
                    document.getElementById('roll-btn').click();
                } else if (linkForKey[key]) {
                    window.location.href = linkForKey[key];
                }
            });
        });
    </script>
    <table>
        <tr>
            <td style="background-color: #2a2a2a; border-bottom: 2px solid #ffffff;">
                <h2 style="margin: 10px 10px">{{ current.name }}</h2>
            </td>
        </tr>
        {% if current.description %}
        <tr>
            <td>
                <p>{{ current.description|htmlify }}</p>
            </td>
        </tr>
        {% endif %}
        <tr>
            <td>
                <form method="POST" action="{{ url_for('play_event', event_id=current.id) }}">
                    {% if current.outcome_type == 'fourway' %}
                        <label for="difficulty" style="padding-left: 10px;">Difficulty:</label>
                        <select id="difficulty" name="difficulty">
                            <option value="5">Easy (5)</option>
                            <option value="10">Moderate (10)</option>
                            <option value="15">Hard (15)</option>
                            <option value="20">Very Hard (20)</option>
                        </select><br>
                    {% endif %}
                    {% if current.outcome_type == 'fourway' or current.outcome_type == 'numeric' %}
                        <div style="background-color: black; margin: 0px; padding: 10px">
                        <label for="stat_adjustment">Stat Adjustment:</label>
                        <input type="text" id="stat_adjustment" name="stat_adjustment" value="{{ current.stat_adjustment }}">
                        <br>
                        {% for attr in current.determining_attrs %}
                            <li>{{ attr.name }}
                            <select class="char-for-attr" id="char-for-attr_{{ attr.id }}">
                                <option value="" selected>(Select character)</option>
                                {% for char in game_data.characters if attr.id in char.attribs %}
                                    {% set attrib_val = char.attribs[attr.id].val | formatNum %}
                                    <option value="{{ attrib_val }}" {% if char.id == session['last_char_id'] %}selected{% endif %}>{{ char.name }} {{ attrib_val }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="fill-btn" data-attr-id="{{ attr.id }}">Fill</button><br>
                        {% endfor %}
                        </div>
                    {% endif %}
                    <div style="margin-top: 20px">
                    <button type="submit" id="roll-btn">[R]oll</button>
                    </div>
                </form>
            </td>
        </tr>
        {% if outcome %}
        <tr>
            <td>
                <div id="outcome-display">{{ outcome|safe }}</div>
            </td>
        </tr>
        {% endif %}
    </table>
    <script>
        $(document).ready(function() {
            // remember default for select box in client side storage
            let selectedDifficulty = localStorage.getItem('selectedDifficulty');
            if (selectedDifficulty === null) {
                selectedDifficulty = '10';
                localStorage.setItem('selectedDifficulty', selectedDifficulty);
            }
            document.getElementById('difficulty').value = selectedDifficulty;
            document.getElementById('difficulty').addEventListener('change', function() {
                localStorage.setItem('selectedDifficulty', this.value);
            });
            
            function updateStatAdjustment(event) {
                const selectedValue = event.target.value;
                const statAdjustmentInput = document.getElementById('stat_adjustment');
                statAdjustmentInput.value = selectedValue;
            }
            $('.char-for-attr').on('change', updateStatAdjustment);

            $('.fill-btn').on('click', function() {
                var attrId = $(this).data('attr-id');
                var selectedValue = $('#char-for-attr_' + attrId).val();
                $('#stat_adjustment').val(selectedValue);
            });
        });
    </script>
{% endblock %}
