<!DOCTYPE html>
<html>
<head>
    <title>Character Information</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="nav-container">
        <a class="upper-left" href="{{ url_for('overview') }}">Overview</a>
        <span class="separator">|</span>
        <a class="upper-left" href="{{ url_for('configure') }}">General Setup</a>
        <span class="separator">|</span>
        <a class="upper-left" href="{{ url_for('configure_char', char_id=current.id) }}">Character Setup</a>
    </div>
    <h1>{{ current.name }}</h1>
    {% if current.description %}
        <p>{{ current.description }}</p>
    {% endif %}
    {% if current.char_type.lower() == "npc" %}
        <p>NPC</p>
    {% else %}
        <p>Character for {{ current.char_type|capitalize }}</p>
    {% endif %}

    {% if current.location %}
        <p>Location: <a href="{{ url_for('play_location', location_id=current.location.id) }}">{{ current.location.name }}</a></p>
        {% if current.location.destinations %}
            <div class="flexdiv">
                <label for="destination-select">Travel To</label>
                <select id="destination-select" class="select-box">
                    <option value="" data-distance="-1">(Select destination)</option>
                    {% for destination, distance in current.location.destinations.items() %}
                        <option value="{{ destination.id }}" data-distance="{{ distance }}"
                            {% if current.destination and destination.id == current.destination.id %}
                                selected
                            {% endif %}
                        >
                            {{ destination.name }}
                        </option>
                    {% endfor %}
                </select>
                <div id="destination-info" class="flexdiv">
                    <p id="destination-distance">Distance: ... of ...</p>
                    <button id="start-travel-btn">Start</button>
                    <button id="stop-travel-btn">Stop</button>
                </div>
            </div>
        {% endif %}
    {% endif %}

    {% if current.items %}
    <h2>Worn Items</h2>
    <ul>
        {% for item, slot in current.items.items() if slot %}
            <li>
                <a href="{{ url_for('play_item', item_id=item.id) }}">{{ item.name }}</a>
                &mdash; {{ slot }}
            </li>
        {% else %}
            (None)
        {% endfor %}
    </ul>

    <h2>Inventory Items</h2>
    <ul>
        {% for item, slot in current.items.items() if not slot %}
            <li>
                <a href="{{ url_for('play_item', item_id=item.id) }}">{{ item.name }}</a>
            </li>
        {% else %}
            (None)
        {% endfor %}
    </ul>
    {% endif %}

    {% if current.attributes %}
    <h2>Attributes (Not Implemented Yet)</h2>
    <ul>
        <!-- Loop over current.attributes once they are implemented -->
    </ul>
    {% endif %}
    <script>
        $(document).ready(function() {
            function updateTravelProgress() {
                const destSel = $('#destination-select');
                const selectedOption = destSel.find(":selected");
                const distance = selectedOption.data("distance");
                const destinationId = destSel.val();
                const destInfo = $('#destination-info');
                const destDist = $('#destination-distance');
                if (destinationId) {
                    $.get('/char/progress_quantity/{{ current.id }}', function(data) {
                        if (data.hasOwnProperty('status') && data.status === 'arrived') {
                            location.reload();
                        } else if (data.hasOwnProperty('error') && data.error === 'No travel destination.') {
                            console.log(data.error);
                        } else {
                            const quantity = data.hasOwnProperty('quantity') ? data.quantity : -1;
                            destDist.text('Distance: ' + quantity + ' of ' + distance);
                            destInfo.show();
                        }
                    });
                } else {
                    destInfo.hide();
                }
            }

            // the Start button may change to "Running..."
            function updateStartbuttonLabel() {
                fetch('/item/progress_running/{{ current.id }}')
                    .then(response => response.json())
                    .then(data => {
                        const startBtn = $('#start-travel-btn');
                        const stopBtn = $('#stop-travel-btn');
                        const destSel = $('#destination-select');
                        if (data.is_running) {
                            startBtn.innerHTML = "Travelling...";
                            startBtn.disabled = true;
                            stopBtn.disabled = false;
                            destSel.disabled = true;
                        } else {
                            startBtn.innerHTML = "Start";
                            startBtn.disabled = false;
                            stopBtn.disabled = true;
                            destSel.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }

            // Update initially
            updateTravelProgress();
            updateStartbuttonLabel();

            // Update every second
            setInterval(function() {
                updateTravelProgress();
                updateStartbuttonLabel();
            }, 1000);

            $('#destination-select').change(function() {
                updateTravelProgress();
            });

            $('#start-travel-btn').click(function() {
                // Start the progress for the selected destination
                const destinationId = $('#destination-select').val();
                const current_id = {{ current.id }};
                console.log('startItem(): ' + current_id);
                $.ajax({
                    url: '/char/start/' + current_id,
                    method: 'POST',
                    data: { dest_id: destinationId },
                    success: function(response) {
                        if (response.status === 'error') {
                            console.error(response.message);
                            alert(response.message);
                        }
                        updateStartbuttonLabel();
                    },
                    error: function(error) {
                        console.error('Error:', error);
                    },
                    complete: function() {
                        updateTravelProgress();
                    }
                });
            });
            $('#stop-travel-btn').click(function() {
                // Stop the progress
                const current_id = {{ current.id }}
                console.log('stopItem(): ' + current_id);
                fetch('/item/stop/' + current_id)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        updateStartbuttonLabel();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
        });
    </script>
</body>
</html>

