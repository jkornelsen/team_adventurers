<!DOCTYPE html>
<html>
<head>
    <title>{{ config['TITLE'] }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Item Setup</h1>
    <form method="post">
        <label for="item-name">Name:</label>
        <input type="text" id="item-name" name="item_name" value="{{ current.name }}" required><br>
        <p>ID: {{ current.id }}</p>
        <label for="item-description" >Description:</label>
        <textarea id="item-description" name="item_description" rows="4" cols="50">{{ current.description }}</textarea><br>

        <div>
            <input type="checkbox" id="top_level" name="top_level" {% if current.toplevel %}checked{% endif %}>
            <label for="top_level">Show in Overview</label><br>
            <input type="radio" id="growable-gain-over_time" name="growable" value="over_time" {% if current.growable != "instantly" and current.growable != "not_growable" %}checked{% endif %}>
            <label for="growable-gain-over_time">Gain over time</label>
            <input type="radio" id="growable-gain-instantly" name="growable" value="instantly" {% if current.growable == "instantly" %}checked{% endif %}>
            <label for="growable-gain-instantly">Gain instantly</label>
            <input type="radio" id="growable-not_growable" name="growable" value="not_growable" {% if current.growable == "not_growable" %}checked{% endif %}>
            <label for="growable-not_growable">Not growable</label>
        </div>
        <div id="rate-container" {% if current.growable == "instantly" or current.growable == "not_growable" %}style="display: none;"{% endif %}>
            <label for="rate-amount">Rate:</label>
            <input type="number" id="rate-amount" name="rate_amount" value="{{ current.progress.rate_amount }}" required>
            <span>per</span>
            <input type="text" size="6" id="rate-duration" name="rate_duration" value="{{ current.progress.rate_duration }}" required>
            <span>seconds</span><br>
        </div>

        <div id="source-container" style="border: 1px solid #ccc; padding: 10px;">
            <div class="source flexdiv" data-source-id="result">
                <label for="result-quantity">Gives</label>
                <input type="number" id="result-quantity" name="result_quantity" value="{{ current.result_qty }}">
            </div>
                {% for source_item, source_qty in current.sources.items() %}
                    <div class="source flexdiv" data-source-id="{{ source_item.id }}">
                        <input type="hidden" name="source_id" value="{{ source_item.id }}">
                        <label>Takes</label>
                        <input type="number" id="source-{{ source_item.id }}-quantity" name="source_quantity_{{ source_item.id }}" value="{{ source_qty }}">
                        {{ source_item.name }}
                        <button class="remove-source-btn lesser-button">Remove Source</button>
                    </div>
                {% endfor %}

                <!-- Placeholder for appending new sources -->
                <div id="sourcelist_end" style="width: 0; height: 0; opacity: 0;"></div>
                {% set outerscope = namespace(has_other_item = false) %}
                {% for item in current.__class__.instances %}
                    {% if item.id != current.id %}
                        {% set outerscope.has_other_item = true %}
                    {% endif %}
                {% endfor %}
                {% if outerscope.has_other_item %}
                    <!-- Select box for adding another source -->
                    <div class="select-box">
                        <select id="add-source-select">
                            <option value="" selected>(Select item)</option>
                            {% for item in current.__class__.instances %}
                                {% if item.id != current.id %}
                                <option value="{{ item.id }}">{{ item.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <button type="button" id="add-source-btn" class="lesser-button">Add Source</button>
                    </div>
                {% else %}
                    <p class="no-items">(No other items)</p>
                {% endif %}
            </div>
        </div>

        <button type="submit" id="btn-save" name="save_changes">Save and Continue</button>
        <button type="submit" id="btn-cancel" name="cancel_changes" formnovalidate>Cancel Changes</button>
        <button type="submit" id="btn-delete" name="delete_item" class="dangerous-button">Delete Item</button>
    </form>
    <script>
        $(document).ready(function() {
            // Enable button if the current entity has been configured before.
            {% set outerscope = namespace(has_current = false) %}
            {% for item in current.__class__.instances %}
                {% if item.id == current.id %}
                    {% set outerscope.has_current = true %}
                {% endif %}
            {% endfor %}
            {% if outerscope.has_current %}
                $('#btn-delete').removeAttr('disabled');
            {% else %}
                $('#btn-delete').attr('disabled', 'disabled');
            {% endif %}

            $('input[name="growable"]').change(function() {
              var growableValue = $(this).val();
              
              // Toggle visibility of rate-related elements based on the selected option
              if (growableValue === "over_time") {
                $('#rate-container').show();
              } else {
                $('#rate-container').hide();
              }
              
              // Toggle disabled state of source input boxes based on the selected option
              var isGrowable = (growableValue === "over_time" || growableValue === "instantly");
              $('#source-container input').prop('disabled', !isGrowable);
            });

            $('#add-source-btn').click(function() {
                var selectedOption = $('#add-source-select option:selected');
                var sourceId = selectedOption.val();
                var sourceName = selectedOption.text();
                if (sourceId == "") {
                    return; // don't add if the selected option is the placeholder
                }
                var existingSource = $('.source[data-source-id="' + sourceId + '"]');
                if (existingSource.length > 0) {
                    alert('Source already exists.');
                    return;
                }
                // Create HTML elements for the source
                var sourceHtml = `
                    <div class="source flexdiv" data-source-id="${sourceId}">
                        <input type="hidden" name="source_id" value="${sourceId}">
                        <label>Takes:</label>
                        <input type="number" id="source-${sourceId}-quantity" name="source_quantity_${sourceId}" value="1">
                        ${sourceName}
                        <button class="remove-source-btn lesser-button">Remove Source</button>
                    </div>
                `;
                $('#sourcelist_end').before(sourceHtml);
            });

            $('#source-container').on('click', '.remove-source-btn', function() {
                var sourceContainer = $(this).closest('.source');
                var sourceId = sourceContainer.data('source-id');

                // Remove the source from the DOM
                sourceContainer.remove();
            });
            $('#btn-save').click(function() {
                var growable = $('input[name="growable"]:checked').val();
                var rateAmount = parseFloat($('#rate-amount').val());
                var resultQty = parseInt($('#result-quantity').val(), 10);
                if (growable === "over_time" && rateAmount < resultQty) {
                    alert('Rate amount must be at least as high as the result quantity (labeled "Gives").');
                    return false; // Prevent form submission
                }
            });
        });
    </script>
</body>
</html>
