{% extends 'base.html' %}

{% block content %}
    <h1>Item Setup</h1>
    <p>These are the most versatile things in the game.
    In addition to typical items such as resources or gear,
    they can represent an upgrade in production speed, or money or reputation.
    They could even be people if they don't need to perform any actions.
    For more ideas on how they can be used, browse the pre-built scenarios.
    </p>
    <form method="post">
        <label for="item-name">Name:</label>
        <input type="text" id="item-name" name="item_name" value="{{ current.name }}" required>
        ID: {{ current.id }}<br>
        <label for="item-description" >Description:</label>
        <textarea id="item-description" name="item_description" rows="4" cols="50">{{ current.description }}</textarea><br>
        <label for="item-quantity">Quantity:</label>
        <input type="number" id="item-quantity" name="item_quantity" value="{{ current.progress.quantity }}"><span id="running-label"></span>
        <label for="item-limit">Limit:</label>
        <input type="number" id="item-limit" name="item_limit" value="{{ current.progress.limit }}"><br>
        <div>
            <input type="checkbox" id="top_level" name="top_level" {% if current.toplevel %}checked{% endif %}>
            <label for="top_level">Show in Overview</label><br>
            <input type="radio" id="growable-gain-over_time" name="growable" value="over_time" {% if current.growable != "instantly" and current.growable != "not_growable" %}checked{% endif %}>
            <label for="growable-gain-over_time">Gain over time</label>
            <input type="radio" id="growable-gain-instantly" name="growable" value="instantly" {% if current.growable == "instantly" %}checked{% endif %}>
            <label for="growable-gain-instantly">Gain instantly</label>
            <input type="radio" id="growable-not_growable" name="growable" value="not_growable" {% if current.growable == "not_growable" %}checked{% endif %}>
            <label for="growable-not_growable">Not growable</label>
        </div>
        <div id="rate-container" {% if current.growable == "instantly" or current.growable == "not_growable" %}style="display: none;"{% endif %}>
            <label for="rate-amount">Rate:</label>
            <input type="number" id="rate-amount" name="rate_amount" value="{{ current.progress.rate_amount }}" required>
            <span>per</span>
            <input type="text" size="6" id="rate-duration" name="rate_duration" value="{{ current.progress.rate_duration }}" required>
            <span>seconds</span><br>
        </div>

        <div id="source-container" style="border: 1px solid #ccc; padding: 10px;">
            <div class="source flexdiv" data-source-id="result">
                <label for="result-quantity">Gives</label>
                <input type="number" id="result-quantity" name="result_quantity" value="{{ current.result_qty }}">
            </div>
                {% for source_item, source_qty in current.sources.items() %}
                    <div class="source flexdiv" data-source-id="{{ source_item.id }}">
                        <input type="hidden" name="source_id" value="{{ source_item.id }}">
                        <label>Takes</label>
                        <input type="number" id="source-{{ source_item.id }}-quantity" name="source_quantity_{{ source_item.id }}" value="{{ source_qty }}">
                        {{ source_item.name }}
                        <button class="remove-source-btn lesser-button">Remove Source</button>
                    </div>
                {% endfor %}

                <!-- Placeholder for appending new sources -->
                <div id="sourcelist_end" style="width: 0; height: 0; opacity: 0;"></div>
                {% set outerscope = namespace(has_other_item = false) %}
                {% for item in current.__class__.instances %}
                    {% if item.id != current.id %}
                        {% set outerscope.has_other_item = true %}
                    {% endif %}
                {% endfor %}
                {% if outerscope.has_other_item %}
                    <!-- Select box for adding another source -->
                    <div class="select-box">
                        <select id="add-source-select">
                            <option value="" selected>(Select item)</option>
                            {% for item in current.__class__.instances %}
                                {% if item.id != current.id %}
                                <option value="{{ item.id }}">{{ item.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <button type="button" id="add-source-btn" class="lesser-button">Add Source</button>
                    </div>
                {% else %}
                    <p class="no-items">(No other items)</p>
                {% endif %}
            </div>
        </div>

        <div id="attrib-container" style="border: 1px solid #ccc; padding: 10px;">
                {% for attrib, attrib_val in current.attribs.items() %}
                    <div class="attrib flexdiv" data-attrib-id="{{ attrib.id }}">
                        <input type="hidden" name="attrib_id" value="{{ attrib.id }}">
                        {{ attrib.name }}
                        <input type="number" id="attrib-{{ attrib.id }}-val" name="attrib_val_{{ attrib.id }}" value="{{ attrib_val }}">
                        <button class="remove-attrib-btn lesser-button">Remove Attribute</button>
                    </div>
                {% endfor %}

                <!-- Placeholder for appending new attribs -->
                <div id="attriblist_end" style="width: 0; height: 0; opacity: 0;"></div>
                {% if game_data.attribs %}
                    <!-- Select box for adding another attrib -->
                    <div class="select-box">
                        <select id="add-attrib-select">
                            <option value="" selected>(Select item)</option>
                            {% for attrib in game_data.attribs %}
                                <option value="{{ attrib.id }}">{{ attrib.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" id="add-attrib-btn" class="lesser-button">Add Attribute</button>
                    </div>
                {% else %}
                    <p class="no-attributes">(No attributes)</p>
                {% endif %}
            </div>
        </div>

        <button type="submit" id="btn-save" name="save_changes">Save and Continue</button>
        <button type="submit" id="btn-cancel" name="cancel_changes" formnovalidate>Cancel Changes</button>
        <button type="submit" id="btn-delete" name="delete_item" class="dangerous-button">Delete Item</button>
    </form>
    <script>
        $(document).ready(function() {
            // Enable button if the current entity has been configured before.
            {% set outerscope = namespace(has_current = false) %}
            {% for item in current.__class__.instances %}
                {% if item.id == current.id %}
                    {% set outerscope.has_current = true %}
                {% endif %}
            {% endfor %}
            {% if outerscope.has_current %}
                $('#btn-delete').removeAttr('disabled');
            {% else %}
                $('#btn-delete').attr('disabled', 'disabled');
            {% endif %}

            // disable changing quantity if currently in progress
            const itemQuantityInput = $('#item-quantity');
            if ({{ current.progress.is_ongoing|lower }}) {
                itemQuantityInput.prop('disabled', true);
                $('#running-label').text('(Running)');
            }

            function updateGrowableVisibility() {
                // Toggle visibility of rate-related elements based on the selected option
                if ($('#growable-gain-over_time').is(':checked')) {
                    $('#rate-container').show();
                } else {
                    $('#rate-container').hide();
                }
                if ($('#growable-not_growable').is(':checked')) {
                    $('#source-container').hide();
                    //$('#source-container input').prop('disabled', true);
                } else {
                    $('#source-container').show();
                }
            }
            $('input[name="growable"]').change(updateGrowableVisibility);
            updateGrowableVisibility();

            $('#add-source-btn').click(function() {
                const selectedOption = $('#add-source-select option:selected');
                const sourceId = selectedOption.val();
                const sourceName = selectedOption.text();
                if (sourceId == "") {
                    return; // don't add if the selected option is the placeholder
                }
                const existingSource = $('.source[data-source-id="' + sourceId + '"]');
                if (existingSource.length > 0) {
                    alert('Source already exists.');
                    return;
                }
                // Create HTML elements for the source
                const sourceHtml = `
                    <div class="source flexdiv" data-source-id="${sourceId}">
                        <input type="hidden" name="source_id" value="${sourceId}">
                        <label>Takes:</label>
                        <input type="number" id="source-${sourceId}-quantity" name="source_quantity_${sourceId}" value="1">
                        ${sourceName}
                        <button class="remove-source-btn lesser-button">Remove Source</button>
                    </div>
                `;
                $('#sourcelist_end').before(sourceHtml);
            });

            $('#source-container').on('click', '.remove-source-btn', function() {
                const sourceContainer = $(this).closest('.source');
                const sourceId = sourceContainer.data('source-id');

                // Remove the source from the DOM
                sourceContainer.remove();
            });

            $('#add-attrib-btn').click(function() {
                const selectedOption = $('#add-attrib-select option:selected');
                const attribId = selectedOption.val();
                const attribName = selectedOption.text();
                if (attribId == "") {
                    return; // don't add if the selected option is the placeholder
                }
                const existingAttrib = $('.attrib[data-attrib-id="' + attribId + '"]');
                if (existingAttrib.length > 0) {
                    alert('Attribute already exists.');
                    return;
                }
                // Create HTML elements for the attrib
                const attribHtml = `
                    <div class="attrib flexdiv" data-attrib-id="${attribId}">
                        <input type="hidden" name="attrib_id" value="${attribId}">
                        ${attribName}
                        <input type="number" id="attrib-${attribId}-val" name="attrib_val_${attribId}" value="1">
                        <button class="remove-attrib-btn lesser-button">Remove Attribute</button>
                    </div>
                `;
                $('#attriblist_end').before(attribHtml);
            });

            $('#attrib-container').on('click', '.remove-attrib-btn', function() {
                const attribContainer = $(this).closest('.attrib');
                const attribId = attribContainer.data('attrib-id');

                // Remove the attrib from the DOM
                attribContainer.remove();
            });

            $('#btn-save').click(function() {
                const growable = $('input[name="growable"]:checked').val();
                const rateAmount = parseFloat($('#rate-amount').val());
                const resultQty = parseInt($('#result-quantity').val(), 10);
                if (growable === "over_time" && rateAmount < resultQty) {
                    alert('Rate amount must be at least as high as the result quantity (labeled "Gives").');
                    return false; // Prevent form submission
                }
            });
        });
    </script>
{% endblock %}
